# モジュール詳細設計

## 日時
2025-12-04

## 概要
母音検知モジュールの詳細設計を定義します。カメラアクセス、MediaPipe統合、母音判定ロジックの具体的な実装方針を記載します。

---

## アーキテクチャ概要

```
┌─────────────────────────────────────────────────────┐
│                  VowelTracker                       │
│  (メインAPI - ユーザーが直接使用するクラス)          │
└─────────────────┬───────────────────────────────────┘
                  │
        ┌─────────┴─────────┐
        │                   │
┌───────▼──────────┐  ┌────▼────────────────┐
│ CameraManager    │  │ FaceLandmarker      │
│ (カメラ制御)     │  │ Wrapper             │
└──────────────────┘  │ (MediaPipe統合)     │
                      └─────────┬───────────┘
                                │
                      ┌─────────▼───────────┐
                      │  VowelDetector      │
                      │  (母音判定ロジック)  │
                      └─────────────────────┘
```

---

## 1. CameraManager（カメラ管理）

### 責務
- Webカメラへのアクセス
- ビデオストリームの取得と管理
- カメラの開始・停止制御

### クラス設計

```typescript
class CameraManager {
  private stream: MediaStream | null = null;
  private videoElement: HTMLVideoElement | null = null;

  /**
   * カメラを起動してビデオ要素に接続
   * @param videoElement - ビデオ表示用のHTML要素
   * @param constraints - カメラ制約（解像度、フレームレートなど）
   */
  async start(
    videoElement: HTMLVideoElement,
    constraints?: MediaStreamConstraints
  ): Promise<void>;

  /**
   * カメラを停止してストリームを解放
   */
  stop(): void;

  /**
   * 現在のビデオ要素を取得
   */
  getVideoElement(): HTMLVideoElement | null;

  /**
   * カメラが起動中かどうか
   */
  isActive(): boolean;
}
```

### 実装詳細

#### カメラ制約のデフォルト値
```typescript
const DEFAULT_CAMERA_CONSTRAINTS = {
  video: {
    width: { ideal: 640 },
    height: { ideal: 480 },
    frameRate: { ideal: 30 },
    facingMode: 'user', // フロントカメラ
  },
  audio: false,
};
```

#### エラーハンドリング
- `NotAllowedError`: カメラ権限が拒否された
- `NotFoundError`: カメラデバイスが見つからない
- `NotReadableError`: カメラが他のアプリで使用中
- すべてのエラーを適切なメッセージで再スロー

---

## 2. FaceLandmarkerWrapper（MediaPipe統合）

### 責務
- MediaPipe FaceLandmarkerの初期化
- モデルファイルの読み込み
- ビデオフレームからの顔ランドマーク検出
- 検出結果の正規化

### クラス設計

```typescript
class FaceLandmarkerWrapper {
  private faceLandmarker: FaceLandmarker | null = null;
  private isInitialized = false;

  /**
   * MediaPipeモデルを初期化
   * @param modelPath - モデルファイルのパス
   */
  async initialize(modelPath: string): Promise<void>;

  /**
   * ビデオフレームから顔ランドマークを検出
   * @param videoElement - ビデオ要素
   * @returns 検出された顔ランドマーク（検出失敗時はnull）
   */
  detect(videoElement: HTMLVideoElement): FaceLandmarkResult | null;

  /**
   * リソースを解放
   */
  dispose(): void;
}
```

### 実装詳細

#### MediaPipe初期化設定
```typescript
const FACE_LANDMARKER_OPTIONS = {
  baseOptions: {
    modelAssetPath: modelPath,
    delegate: 'GPU', // GPU加速を使用
  },
  runningMode: 'VIDEO', // ビデオモード
  numFaces: 1, // 1つの顔のみ検出
  minFaceDetectionConfidence: 0.5,
  minFacePresenceConfidence: 0.5,
  minTrackingConfidence: 0.5,
  outputFaceBlendshapes: true, // 表情パラメータを取得
  outputFacialTransformationMatrixes: false,
};
```

#### 検出結果の構造
```typescript
interface FaceLandmarkResult {
  // 468個の顔ランドマーク座標（正規化済み 0.0-1.0）
  landmarks: Array<{ x: number; y: number; z: number }>;
  
  // 表情パラメータ（52種類のブレンドシェイプ）
  faceBlendshapes?: Array<{
    score: number;        // 0.0-1.0
    categoryName: string; // 例: 'mouthOpen', 'jawOpen'
  }>;
}
```

---

## 3. VowelDetector（母音判定ロジック）

### 責務
- 顔ランドマークから口の形状を分析
- 口の開き具合、幅、形状から母音を判定
- 判定結果の信頼度計算

### クラス設計

```typescript
class VowelDetector {
  private confidenceThreshold: number;

  constructor(confidenceThreshold: number = 0.5);

  /**
   * 顔ランドマークから母音を判定
   * @param landmarks - 顔ランドマーク結果
   * @returns 判定された母音と信頼度
   */
  detect(landmarks: FaceLandmarkResult): VowelDetectionResult;

  /**
   * 口の特徴量を計算
   */
  private calculateMouthFeatures(
    landmarks: FaceLandmarkResult
  ): MouthFeatures;

  /**
   * 特徴量から母音を分類
   */
  private classifyVowel(features: MouthFeatures): VowelDetectionResult;
}
```

### 母音判定アルゴリズム

#### 口の特徴量定義
```typescript
interface MouthFeatures {
  // 口の縦の開き（上唇-下唇の距離）
  verticalOpening: number;
  
  // 口の横幅（左端-右端の距離）
  horizontalWidth: number;
  
  // 口の開口率（縦/横の比率）
  aspectRatio: number;
  
  // 唇の形状（丸み具合）
  roundness: number;
  
  // 顎の開き具合
  jawOpening: number;
}
```

#### 母音判定ルール

**1. 閉口 (closed)**
- `verticalOpening < 0.02`
- `jawOpening < 0.1`

**2. あ (a)**
- `verticalOpening > 0.15`
- `aspectRatio > 0.8` （縦長）
- `jawOpening > 0.3`

**3. い (i)**
- `verticalOpening < 0.08`
- `horizontalWidth > 0.3` （横に広い）
- `aspectRatio < 0.3` （横長）

**4. う (u)**
- `verticalOpening < 0.1`
- `horizontalWidth < 0.2` （狭い）
- `roundness > 0.7` （丸い）

**5. え (e)**
- `verticalOpening: 0.08 - 0.12` （中程度）
- `horizontalWidth > 0.25`
- `aspectRatio: 0.4 - 0.6`

**6. お (o)**
- `verticalOpening: 0.1 - 0.15`
- `horizontalWidth < 0.25`
- `roundness > 0.6` （やや丸い）

#### ランドマークインデックス（MediaPipe 468点）

```typescript
const MOUTH_LANDMARKS_INDICES = {
  // 上唇
  UPPER_LIP_TOP: 13,
  UPPER_LIP_BOTTOM: 312,
  
  // 下唇
  LOWER_LIP_TOP: 308,
  LOWER_LIP_BOTTOM: 14,
  
  // 口角
  MOUTH_LEFT: 61,
  MOUTH_RIGHT: 291,
  
  // 口の中心
  MOUTH_CENTER_TOP: 0,
  MOUTH_CENTER_BOTTOM: 17,
  
  // 顎
  JAW_BOTTOM: 152,
  JAW_TOP: 10,
};
```

#### 信頼度計算
```typescript
// 各母音の特徴量との一致度を0-1で計算
// 最も高い一致度を持つ母音を選択
// 信頼度が閾値未満の場合は判定を保留
```

---

## 4. VowelTracker（メインAPI）

### 責務
- 各コンポーネントの統合
- 検出ループの管理
- コールバック通知
- 状態管理

### 処理フロー

```
1. initialize()
   ├─ FaceLandmarkerWrapper.initialize()
   └─ CameraManager.start()

2. start(videoElement)
   ├─ 検出ループ開始（setInterval）
   └─ 各フレームで:
      ├─ FaceLandmarkerWrapper.detect()
      ├─ VowelDetector.detect()
      └─ onVowelDetected() コールバック実行

3. stop()
   ├─ 検出ループ停止
   └─ CameraManager.stop()

4. dispose()
   ├─ stop()
   └─ FaceLandmarkerWrapper.dispose()
```

### 検出ループの実装

```typescript
private startDetectionLoop(videoElement: HTMLVideoElement): void {
  this.detectionTimer = window.setInterval(() => {
    // 1. 顔ランドマーク検出
    const landmarks = this.faceLandmarkerWrapper.detect(videoElement);
    if (!landmarks) return;

    // 2. 母音判定
    const result = this.vowelDetector.detect(landmarks);
    
    // 3. 信頼度チェック
    if (result.confidence < this.options.confidenceThreshold) return;

    // 4. 前回と異なる母音の場合のみコールバック実行
    if (result.vowel !== this.lastDetectedVowel) {
      this.lastDetectedVowel = result.vowel;
      this.options.onVowelDetected(result.vowel);
    }
  }, this.options.detectionInterval);
}
```

---

## 5. ユーティリティ関数

### utils/geometry.ts
```typescript
/**
 * 2点間のユークリッド距離を計算
 */
export function calculateDistance(
  p1: { x: number; y: number },
  p2: { x: number; y: number }
): number;

/**
 * 3点から角度を計算
 */
export function calculateAngle(
  p1: Point,
  p2: Point,
  p3: Point
): number;

/**
 * 点の配列から重心を計算
 */
export function calculateCentroid(points: Point[]): Point;
```

### utils/smoothing.ts
```typescript
/**
 * 移動平均フィルタ（ノイズ除去）
 */
export class MovingAverageFilter {
  private buffer: number[] = [];
  private windowSize: number;

  constructor(windowSize: number = 5);
  
  add(value: number): number;
  reset(): void;
}
```

---

## 6. エラーハンドリング戦略

### カスタムエラークラス
```typescript
export class VowelTrackerError extends Error {
  constructor(
    message: string,
    public code: ErrorCode,
    public originalError?: Error
  ) {
    super(message);
    this.name = 'VowelTrackerError';
  }
}

export enum ErrorCode {
  CAMERA_NOT_AVAILABLE = 'CAMERA_NOT_AVAILABLE',
  CAMERA_PERMISSION_DENIED = 'CAMERA_PERMISSION_DENIED',
  MODEL_LOAD_FAILED = 'MODEL_LOAD_FAILED',
  NOT_INITIALIZED = 'NOT_INITIALIZED',
  DETECTION_FAILED = 'DETECTION_FAILED',
}
```

---

## 7. パフォーマンス最適化

### 最適化ポイント
1. **GPU加速**: MediaPipeのGPUデリゲート使用
2. **検出間隔**: デフォルト100ms（10FPS）で負荷軽減
3. **顔検出数**: 1つの顔のみ検出
4. **ビデオ解像度**: 640x480で十分な精度
5. **移動平均**: 判定結果の平滑化でノイズ除去

---

## 8. 実装順序

### Phase 1: 基盤実装
1. `utils/geometry.ts` - 幾何計算関数
2. `utils/smoothing.ts` - 平滑化フィルタ
3. `utils/errors.ts` - エラークラス

### Phase 2: コンポーネント実装
4. `core/CameraManager.ts` - カメラ管理
5. `core/FaceLandmarkerWrapper.ts` - MediaPipe統合
6. `core/VowelDetector.ts` - 母音判定ロジック

### Phase 3: 統合
7. `core/VowelTracker.ts` - メインAPIの完成
8. 型定義の更新
9. 定数の調整

### Phase 4: テスト
10. ユニットテスト作成
11. 統合テスト
12. デモアプリでの動作確認

---

## 9. 設定可能なパラメータ

```typescript
interface VowelTrackerOptions {
  // モデルパス
  modelPath?: string;
  
  // コールバック
  onVowelDetected?: VowelDetectionCallback;
  
  // 信頼度閾値（0.0-1.0）
  confidenceThreshold?: number;
  
  // 検出間隔（ミリ秒）
  detectionInterval?: number;
  
  // カメラ制約
  cameraConstraints?: MediaStreamConstraints;
  
  // 平滑化ウィンドウサイズ
  smoothingWindowSize?: number;
  
  // デバッグモード
  debug?: boolean;
}
```

---

## 10. デバッグ機能

### デバッグモード時の機能
- ランドマーク座標の可視化
- 特徴量の数値表示
- 判定過程のログ出力
- FPS表示

```typescript
interface DebugInfo {
  fps: number;
  landmarks: Point[];
  mouthFeatures: MouthFeatures;
  detectionResult: VowelDetectionResult;
  processingTime: number;
}
```

---

## まとめ

この設計により、以下を実現します：

1. **モジュール性**: 各コンポーネントが独立し、テスト・保守が容易
2. **拡張性**: 新しい母音や言語への対応が可能
3. **パフォーマンス**: GPU加速と最適化で高速動作
4. **エラーハンドリング**: 適切なエラー処理とユーザーフィードバック
5. **使いやすさ**: シンプルなAPIで簡単に統合可能

次のステップで、この設計に基づいて実装を進めます。

